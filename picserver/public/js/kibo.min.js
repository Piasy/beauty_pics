var Kibo=function(e){this.element=e||window.document;this.initialize()};Kibo.KEY_NAMES_BY_CODE={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"caps_lock",27:"esc",32:"space",33:"page_up",34:"page_down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"num_lock"};Kibo.KEY_CODES_BY_NAME={};(function(){for(var e in Kibo.KEY_NAMES_BY_CODE)if(Object.prototype.hasOwnProperty.call(Kibo.KEY_NAMES_BY_CODE,e))Kibo.KEY_CODES_BY_NAME[Kibo.KEY_NAMES_BY_CODE[e]]=+e})();Kibo.MODIFIERS=["shift","ctrl","alt"];Kibo.WILDCARD_TYPES=["arrow","number","letter","f"];Kibo.WILDCARDS={arrow:[37,38,39,40],number:[48,49,50,51,52,53,54,55,56,57],letter:[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90],f:[112,113,114,115,116,117,118,119,120,121,122,123]};Kibo.assert=function(e,t){t=t||{};t.name=t.name||"Exception raised";t.message=t.message||"an error has occurred.";try{if(!e)throw t}catch(n){if(typeof console!=="undefined"&&console.log)console.log(n.name+": "+n.message);else window.alert(n.name+": "+n.message)}};Kibo.registerEvent=function(){if(document.addEventListener){return function(e,t,n){e.addEventListener(t,n,false)}}else if(document.attachEvent){return function(e,t,n){e.attachEvent("on"+t,n)}}}();Kibo.unregisterEvent=function(){if(document.removeEventListener){return function(e,t,n){e.removeEventListener(t,n,false)}}else if(document.detachEvent){return function(e,t,n){e.detachEvent("on"+t,n)}}}();Kibo.isArray=function(e){return!!(e&&e.splice)};Kibo.isString=function(e){return typeof e==="string"};Kibo.arrayIncludes=function(){if(Array.prototype.indexOf){return function(e,t){return e.indexOf(t)!==-1}}else{return function(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return true;return false}}}();Kibo.trimString=function(e){return e.replace(/^\s+|\s+$/g,"")};Kibo.neatString=function(e){return Kibo.trimString(e).replace(/\s+/g," ")};Kibo.capitalize=function(e){return e.toLowerCase().replace(/^./,function(e){return e.toUpperCase()})};Kibo.isModifier=function(e){return Kibo.arrayIncludes(Kibo.MODIFIERS,e)};Kibo.prototype.initialize=function(){var e,t=this;this.lastKeyCode=-1;this.lastModifiers={};for(e=0;e<Kibo.MODIFIERS.length;e++)this.lastModifiers[Kibo.MODIFIERS[e]]=false;this.keysDown={any:[]};this.keysUp={any:[]};for(e=0;e<Kibo.WILDCARD_TYPES.length;e++){this.keysDown["any "+Kibo.WILDCARD_TYPES[e]]=[];this.keysUp["any "+Kibo.WILDCARD_TYPES[e]]=[]}this.downHandler=this.handler("down");this.upHandler=this.handler("up");Kibo.registerEvent(this.element,"keydown",this.downHandler);Kibo.registerEvent(this.element,"keyup",this.upHandler);Kibo.registerEvent(window,"unload",function n(){Kibo.unregisterEvent(t.element,"keydown",t.downHandler);Kibo.unregisterEvent(t.element,"keyup",t.upHandler);Kibo.unregisterEvent(window,"unload",n)})};Kibo.prototype.matchingKeys=function(e){var t,n,r,i,s=[];for(var o in e){if(Object.prototype.hasOwnProperty.call(e,o)){r=Kibo.trimString(o).split(" ");if(r.length&&r[0]!=="any"){i=true;for(n=0;n<r.length;n++)i=i&&(Kibo.isModifier(r[n])?this.lastKey(r[n]):this.lastKey()===r[n]);if(i)s.push(o)}}}return s};Kibo.prototype.handler=function(e){var t=this;return function(n){var r,i,s,o;n=n||window.event;t.lastKeyCode=n.keyCode;for(r=0;r<Kibo.MODIFIERS.length;r++)t.lastModifiers[Kibo.MODIFIERS[r]]=n[Kibo.MODIFIERS[r]+"Key"];if(Kibo.arrayIncludes(Kibo.MODIFIERS,Kibo.keyName(t.lastKeyCode)))t.lastModifiers[Kibo.keyName(t.lastKeyCode)]=true;o=t["keys"+Kibo.capitalize(e)];s=t.matchingKeys(o);for(r=0;r<o.any.length;r++)if(o.any[r](n)===false&&n.preventDefault)n.preventDefault();for(r=0;r<Kibo.WILDCARD_TYPES.length;r++)if(Kibo.arrayIncludes(Kibo.WILDCARDS[Kibo.WILDCARD_TYPES[r]],t.lastKeyCode))for(i=0;i<o["any "+Kibo.WILDCARD_TYPES[r]].length;i++)if(o["any "+Kibo.WILDCARD_TYPES[r]][i](n)===false&&n.preventDefault)n.preventDefault();for(r=0;r<s.length;r++)for(i=0;i<o[s[r]].length;i++)if(o[s[r]][i](n)===false&&n.preventDefault)n.preventDefault()}};Kibo.prototype.registerKeys=function(e,t,n){var r,i=this["keys"+Kibo.capitalize(e)];if(!Kibo.isArray(t))t=[t];for(r=0;r<t.length;r++){Kibo.assert(Kibo.isString(t[r]),{name:"Type error",message:"expected string or array of strings."});t[r]=Kibo.neatString(t[r]);if(Kibo.isArray(i[t[r]]))i[t[r]].push(n);else i[t[r]]=[n]}return this};Kibo.prototype.unregisterKeys=function(e,t,n){var r,i,s=this["keys"+Kibo.capitalize(e)];if(!Kibo.isArray(t))t=[t];for(r=0;r<t.length;r++){Kibo.assert(Kibo.isString(t[r]),{name:"Type error",message:"expected string or array of strings."});t[r]=Kibo.neatString(t[r]);if(n===null)delete s[t[r]];else{if(Kibo.isArray(s[t[r]])){for(i=0;i<s[t[r]].length;i++){if(String(s[t[r]][i])===String(n)){s[t[r]].splice(i,1);break}}}}}return this};Kibo.prototype.delegate=function(e,t,n){return n!==null?this.registerKeys(e,t,n):this.unregisterKeys(e,t,n)};Kibo.prototype.down=function(e,t){return this.delegate("down",e,t)};Kibo.prototype.up=function(e,t){return this.delegate("up",e,t)};Kibo.keyName=function(e){return Kibo.KEY_NAMES_BY_CODE[e+""]};Kibo.keyCode=function(e){return+Kibo.KEY_CODES_BY_NAME[e]};Kibo.prototype.lastKey=function(e){if(!e)return Kibo.keyName(this.lastKeyCode);Kibo.assert(Kibo.arrayIncludes(Kibo.MODIFIERS,e),{name:"Modifier error",message:"invalid modifier "+e+" (valid modifiers are: "+Kibo.MODIFIERS.join(", ")+")."});return this.lastModifiers[e]}